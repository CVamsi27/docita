generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String                 @id @default(cuid())
  email                     String                 @unique
  password                  String
  name                      String
  role                      Role                   @default(DOCTOR)
  clinicId                  String?
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt
  qualification             String?
  registrationNumber        String?
  signatureUrl              String?
  bio                       String?
  consultationFee           Float?
  hospitalRole              HospitalRole?
  licenseExpiry             DateTime?
  licenseNumber             String?
  phoneNumber               String?
  profilePhotoUrl           String?
  specialization            Specialization?
  yearsOfExperience         Int?
  appointments              Appointment[]
  certifications            DoctorCertification[]
  doctorClinics             DoctorClinic[]
  educationHistory          DoctorEducation[]
  favoriteCodes             DoctorFavoriteCode[]
  schedules                 DoctorSchedule[]
  additionalSpecializations DoctorSpecialization[]
  timeOffs                  DoctorTimeOff[]
  feedbacks                 Feedback[]
  prescriptions             Prescription[]
  prescriptionTemplates     PrescriptionTemplate[]
  queueTokens               QueueToken[]
  clinic                    Clinic?                @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
  @@index([specialization])
}

model DoctorEducation {
  id           String   @id @default(cuid())
  doctorId     String
  degree       String
  fieldOfStudy String?
  institution  String
  location     String?
  startYear    Int?
  endYear      Int?
  isOngoing    Boolean  @default(false)
  grade        String?
  thesis       String?
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  doctor       User     @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([endYear])
}

model DoctorCertification {
  id            String    @id @default(cuid())
  doctorId      String
  name          String
  issuingBody   String
  issueDate     DateTime
  expiryDate    DateTime?
  credentialId  String?
  credentialUrl String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  doctor        User      @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([expiryDate])
}

model DoctorSpecialization {
  id              String         @id @default(cuid())
  doctorId        String
  specialization  Specialization
  isPrimary       Boolean        @default(false)
  certificationId String?
  yearsOfPractice Int?
  createdAt       DateTime       @default(now())
  doctor          User           @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, specialization])
  @@index([doctorId])
  @@index([specialization])
}

model DoctorSchedule {
  id           String    @id @default(cuid())
  doctorId     String
  clinicId     String
  dayOfWeek    DayOfWeek
  startTime    String
  endTime      String
  slotDuration Int       @default(30)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  clinic       Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  doctor       User      @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, clinicId, dayOfWeek])
  @@index([doctorId])
  @@index([clinicId])
  @@index([dayOfWeek])
}

model DoctorTimeOff {
  id        String   @id @default(cuid())
  doctorId  String
  clinicId  String?
  startDate DateTime
  endDate   DateTime
  reason    String?
  isFullDay Boolean  @default(true)
  startTime String?
  endTime   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clinic    Clinic?  @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  doctor    User     @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([clinicId])
  @@index([startDate, endDate])
}

model Patient {
  id                       String           @id @default(cuid())
  // Medical Record Number - Clinic-prefixed sequential (e.g., "DOC-00001")
  mrn                      String?          @unique
  firstName                String
  lastName                 String
  preferredName            String?          // Name patient prefers to be called
  pronouns                 String?          // e.g., "he/him", "she/her", "they/them"
  dateOfBirth              DateTime
  phoneNumber              String
  email                    String?
  address                  String?
  medicalHistory           String[]         // Legacy field - kept for backward compatibility
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  allergies                String?          // Legacy field - kept for backward compatibility
  bloodGroup               String?
  clinicId                 String
  customData               Json?            @default("{}")
  gender                   Gender
  
  // Hospital-Grade Demographics (Compliance: HL7, USCDI, Meaningful Use)
  race                     String?          // e.g., "White", "Black", "Asian", "Native American", etc.
  ethnicity                String?          // e.g., "Hispanic or Latino", "Not Hispanic or Latino"
  preferredLanguage        String?          @default("en") // ISO 639-1 language code
  maritalStatus            String?          // e.g., "Single", "Married", "Divorced", "Widowed"
  
  // Emergency Contact (Critical for hospital settings)
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?          // e.g., "Spouse", "Parent", "Sibling"
  
  // Patient Safety - Code Status (DNR/Full Code) - CRITICAL
  codeStatus               CodeStatus       @default(FULL_CODE)
  codeStatusUpdatedAt      DateTime?
  codeStatusUpdatedBy      String?          // Doctor ID who updated
  advanceDirectiveUrl      String?          // Link to advance directive document
  
  // Consent tracking
  whatsappConsent          Boolean          @default(false)
  whatsappConsentAt        DateTime?
  
  // Legacy relations
  appointments             Appointment[]
  documents                Document[]
  invoices                 Invoice[]
  clinic                   Clinic           @relation(fields: [clinicId], references: [id])
  tags                     PatientTag[]
  paymentSessions          PaymentSession[]
  prescriptions            Prescription[]
  queueTokens              QueueToken[]
  whatsappLogs             WhatsappLog[]
  
  // Structured medical data relations
  medicalConditions        PatientMedicalCondition[]
  patientAllergies         PatientAllergy[]
  familyHistory            PatientFamilyHistory[]
  socialHistory            PatientSocialHistory?
  surgicalHistory          PatientSurgicalHistory[]
  immunizations            Immunization[]
  consents                 Consent[]

  @@index([mrn])
  @@index([phoneNumber])
  @@index([clinicId])
  @@index([createdAt])
  @@index([clinicId, phoneNumber])
  @@index([email])
  @@index([codeStatus])
}

// ============================================================================
// Structured Medical History Models
// ============================================================================

// Chronic conditions, past illnesses, and ongoing medical conditions
model PatientMedicalCondition {
  id              String                @id @default(cuid())
  patientId       String
  conditionName   String                // e.g., "Type 2 Diabetes Mellitus"
  icdCode         String?               // Optional ICD-10 code reference
  conditionType   MedicalConditionType  @default(CHRONIC)
  status          ConditionStatus       @default(ACTIVE)
  severity        ConditionSeverity?
  diagnosedDate   DateTime?
  resolvedDate    DateTime?
  diagnosedBy     String?               // Doctor who diagnosed
  notes           String?
  // For tracking if this was auto-suggested from appointments
  sourceType      ConditionSourceType   @default(MANUAL)
  sourceAppointmentId String?           // If auto-suggested from an appointment diagnosis
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  patient         Patient               @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@index([conditionType])
  @@index([status])
  @@index([icdCode])
}

// Detailed allergy tracking with severity and reactions
model PatientAllergy {
  id              String            @id @default(cuid())
  patientId       String
  allergen        String            // e.g., "Penicillin", "Peanuts"
  allergyType     AllergyType       @default(DRUG)
  severity        AllergySeverity   @default(MODERATE)
  reaction        String?           // e.g., "Anaphylaxis", "Rash", "Hives"
  onsetDate       DateTime?
  verifiedBy      String?           // Doctor who verified
  verifiedAt      DateTime?
  isVerified      Boolean           @default(false)
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  patient         Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@index([allergyType])
  @@index([severity])
}

// Family medical history
model PatientFamilyHistory {
  id              String    @id @default(cuid())
  patientId       String
  condition       String    // e.g., "Diabetes", "Heart Disease"
  relationship    String    // e.g., "Father", "Mother", "Sibling"
  ageAtOnset      Int?      // Age when the relative was diagnosed
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  patient         Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
}

// Social history (smoking, alcohol, occupation, etc.)
model PatientSocialHistory {
  id                String    @id @default(cuid())
  patientId         String    @unique
  smokingStatus     SmokingStatus?
  smokingPackYears  Float?    // Pack-years for smokers
  smokingQuitDate   DateTime?
  alcoholUse        AlcoholUseStatus?
  alcoholFrequency  String?   // e.g., "2-3 drinks per week"
  substanceUse      String?
  occupation        String?
  occupationalHazards String?
  exerciseFrequency String?
  dietaryRestrictions String?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  patient           Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

// Surgical history
model PatientSurgicalHistory {
  id              String    @id @default(cuid())
  patientId       String
  procedureName   String    // e.g., "Appendectomy", "CABG"
  procedureDate   DateTime?
  hospital        String?
  surgeon         String?
  complications   String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  patient         Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
}

// ============================================================================
// Medical History Enums
// ============================================================================

enum MedicalConditionType {
  CHRONIC           // Ongoing conditions like Diabetes, Hypertension
  ACUTE             // Short-term conditions
  CONGENITAL        // Present from birth
  INFECTIOUS        // Infectious diseases
  AUTOIMMUNE        // Autoimmune conditions
  PSYCHIATRIC       // Mental health conditions
  OTHER
}

enum ConditionStatus {
  ACTIVE            // Currently ongoing
  MANAGED           // Under control with treatment
  RESOLVED          // No longer present
  IN_REMISSION      // For conditions like cancer
}

enum ConditionSeverity {
  MILD
  MODERATE
  SEVERE
  CRITICAL
}

enum ConditionSourceType {
  MANUAL            // Manually entered by staff
  AUTO_SUGGESTED    // Auto-suggested from recurring diagnoses
  IMPORTED          // Imported from external records
}

enum AllergyType {
  DRUG              // Medication allergies
  FOOD              // Food allergies
  ENVIRONMENTAL     // Pollen, dust, etc.
  LATEX             // Latex allergy
  INSECT            // Insect stings/bites
  CONTRAST          // Contrast dye
  OTHER
}

enum AllergySeverity {
  MILD              // Minor symptoms
  MODERATE          // Significant symptoms
  SEVERE            // Serious reactions
  LIFE_THREATENING  // Anaphylaxis risk
}

enum SmokingStatus {
  NEVER
  FORMER
  CURRENT
  UNKNOWN
}

enum AlcoholUseStatus {
  NONE
  OCCASIONAL
  MODERATE
  HEAVY
  UNKNOWN
}

model PatientTag {
  id        String  @id @default(cuid())
  patientId String
  tag       String
  color     String  @default("blue")
  patient   Patient @relation(fields: [patientId], references: [id])

  @@index([patientId])
}

model UploadSession {
  id        String   @id @default(cuid())
  status    String   @default("pending")
  fileUrl   String?
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model Appointment {
  id                      String        @id @default(cuid())
  patientId               String
  doctorId                String
  startTime               DateTime
  endTime                 DateTime
  status                  String        @default("scheduled")
  type                    String
  notes                   String?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  clinicId                String
  observations            String?
  chiefComplaint          String?
  clinicalImpression      String?
  differentialDiagnosis   String?
  finalDiagnosis          String?
  followUpPlan            String?
  generalExamination      Json?
  historyOfPresentIllness String?
  investigations          Json?
  pastMedicalHistory      String?
  provisionalDiagnosis    String?
  reviewOfSystems         String?
  systemicExamination     Json?
  treatmentPlan           String?
  clinic                  Clinic        @relation(fields: [clinicId], references: [id])
  doctor                  User          @relation(fields: [doctorId], references: [id])
  patient                 Patient       @relation(fields: [patientId], references: [id])
  diagnoses               Diagnosis[]
  invoice                 Invoice?
  prescription            Prescription?
  procedures              Procedure[]
  queueToken              QueueToken?
  vitalSign               VitalSign?

  @@index([clinicId])
  @@index([createdAt])
  @@index([startTime])
  @@index([doctorId, startTime])
  @@index([patientId, startTime])
  @@index([status, startTime])
  @@index([doctorId])
  @@index([patientId])
}

model VitalSign {
  id              String            @id @default(cuid())
  appointmentId   String            @unique
  height          Float?            // in cm
  weight          Float?            // in kg
  
  // Legacy blood pressure field - kept for backward compatibility
  bloodPressure   String?           // Legacy format "120/80"
  
  // Structured blood pressure fields (Hospital-Grade)
  systolicBP      Int?              // Systolic blood pressure (mmHg) - normal range 90-120
  diastolicBP     Int?              // Diastolic blood pressure (mmHg) - normal range 60-80
  bpPosition      BpPosition?       // Patient position when BP was taken
  bpMigrationStatus BpMigrationStatus? // Status of legacy BP migration
  
  pulse           Int?              // Heart rate (bpm)
  temperature     Float?            // Body temperature (Celsius)
  
  // Oxygen saturation with delivery context
  spo2            Int?              // SpO2 percentage (%)
  oxygenDelivery  OxygenDelivery?   // How oxygen is being delivered
  oxygenFlowRate  Float?            // Flow rate in L/min (if applicable)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  bloodGlucose    Float?            // Blood glucose (mg/dL)
  bmi             Float?            // Calculated BMI
  notes           String?
  painScore       Int?              // Pain score 0-10
  respiratoryRate Int?              // Breaths per minute
  
  // Additional pediatric/specialty vitals
  headCircumference Float?          // For pediatrics (cm)
  waistCircumference Float?         // For metabolic assessments (cm)
  
  appointment     Appointment       @relation(fields: [appointmentId], references: [id])
  
  @@index([bpMigrationStatus])
}

model Prescription {
  id            String       @id @default(cuid())
  appointmentId String       @unique
  patientId     String
  doctorId      String
  instructions  String?
  date          DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  medications   Medication[]
  appointment   Appointment  @relation(fields: [appointmentId], references: [id])
  doctor        User         @relation(fields: [doctorId], references: [id])
  patient       Patient      @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([createdAt])
  @@index([doctorId, createdAt])
  @@index([doctorId])
}

model Medication {
  id             String       @id @default(cuid())
  prescriptionId String
  name           String       // Drug name (generic or brand)
  
  // Legacy fields - kept for backward compatibility
  dosage         String       // Legacy: combined strength like "500mg"
  frequency      String       // Legacy: free text like "twice daily"
  duration       String       // Legacy: free text like "7 days"
  route          String       @default("PO")
  
  // Structured pharmacy fields (Hospital-Grade)
  ndcCode        String?      // National Drug Code - precise drug identification
  rxNormCui      String?      // RxNorm Concept Unique Identifier
  dosageForm     DosageForm?  // Tablet, Capsule, Injection, etc.
  strengthValue  Float?       // Numeric strength value (e.g., 500)
  strengthUnit   String?      // Unit of strength (e.g., "mg", "mcg", "mL")
  
  // Dispensing information
  quantity       Int?         // Number of units to dispense
  refillsAllowed Int?         @default(0) // Number of refills allowed
  dispenseAsWritten Boolean   @default(false) // DAW - no generic substitution
  
  // Timing
  sigCode        SigCode?     // Standardized frequency code
  startDate      DateTime?    // When to start medication
  endDate        DateTime?    // When to stop medication
  
  // PRN (as needed) medications
  isPRN          Boolean      @default(false)
  prnInstructions String?     // When to take PRN medication
  prnMaxDose     String?      // Maximum dose for PRN
  
  // Special instructions
  specialInstructions String? // Additional instructions
  indication     String?      // Why this medication is prescribed
  
  prescription   Prescription @relation(fields: [prescriptionId], references: [id])
  
  @@index([ndcCode])
  @@index([rxNormCui])
}

model Invoice {
  id              String           @id @default(cuid())
  appointmentId   String?          @unique
  patientId       String
  total           Float
  status          String           @default("pending")
  items           Json
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  appointment     Appointment?     @relation(fields: [appointmentId], references: [id])
  patient         Patient          @relation(fields: [patientId], references: [id])
  paymentSessions PaymentSession[]

  @@index([createdAt])
  @@index([patientId])
  @@index([status, createdAt])
  @@index([status])
}

model Document {
  id          String   @id @default(cuid())
  patientId   String
  name        String
  type        String
  url         String
  fileSize    Int      @default(0)
  mimeType    String   @default("application/octet-stream")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  patient     Patient  @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([createdAt])
}

model PrescriptionTemplate {
  id           String   @id @default(cuid())
  name         String
  userId       String
  medications  Json
  instructions String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
}

model ClinicalTemplate {
  id                  String   @id @default(cuid())
  name                String
  speciality          String
  fields              Json
  defaultObservations String?
  clinicId            String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  clinic              Clinic?  @relation(fields: [clinicId], references: [id])

  @@index([speciality])
  @@index([clinicId])
}

model CustomField {
  id        String   @id @default(cuid())
  name      String
  fieldType String
  options   String?
  required  Boolean  @default(false)
  order     Int      @default(0)
  clinicId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clinic    Clinic?  @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
}

model ReminderSettings {
  id              String   @id @default(cuid())
  enabled         Boolean  @default(true)
  smsEnabled      Boolean  @default(false)
  emailEnabled    Boolean  @default(true)
  hoursBeforeAppt Int      @default(24)
  smsTemplate     String?
  emailTemplate   String?
  emailSubject    String   @default("Appointment Reminder")
  clinicId        String?  @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  clinic          Clinic?  @relation(fields: [clinicId], references: [id])
}

model AppointmentReminder {
  id            String    @id @default(cuid())
  appointmentId String
  type          String
  status        String    @default("pending")
  sentAt        DateTime?
  error         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([appointmentId])
  @@index([status])
}

model Clinic {
  id                      String                   @id @default(cuid())
  name                    String
  address                 String
  phone                   String
  email                   String
  website                 String?
  logo                    String?
  active                  Boolean                  @default(true)
  tier                    ClinicTier               @default(CAPTURE)
  settings                Json?
  timezone                String                   @default("Asia/Kolkata")
  locale                  String                   @default("en-IN")
  currency                String                   @default("INR")
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  subscriptionStatus      String                   @default("active")
  branding                Json?
  features                Json?
  intelligenceAddon       IntelligenceAddon        @default(NONE)
  trialEndsAt             DateTime?
  avgConsultationMinutes  Int                      @default(15)
  lateArrivalGraceMinutes Int                      @default(30)
  queueBufferMinutes      Int                      @default(10)
  useDoctorQueues         Boolean                  @default(false)
  
  // MRN Configuration
  mrnPrefix               String?                  // Prefix for MRN (e.g., "DOC", "CLI")
  
  // Billing-related fields
  razorpayCustomerId      String?                  // Razorpay customer ID for subscriptions
  referralCode            String?                  @unique // Unique referral code for this clinic
  domain                  String?                  // Email domain for referral anti-abuse
  referralCreditsMonths   Int                      @default(0) // Free months earned from referrals (max 12/year)
  // Relations
  appointments            Appointment[]
  auditLogs               AuditLog[]
  clinicalTemplates       ClinicalTemplate[]
  customFields            CustomField[]
  doctorClinics           DoctorClinic[]
  doctorSchedules         DoctorSchedule[]
  doctorTimeOffs          DoctorTimeOff[]
  feedbacks               Feedback[]
  importJobs              ImportJob[]
  patients                Patient[]
  paymentSessions         PaymentSession[]
  queueTokens             QueueToken[]
  reminderSettings        ReminderSettings?
  users                   User[]
  whatsappLogs            WhatsappLog[]
  subscription            Subscription?
  subscriptionPayments    SubscriptionPayment[]
  subscriptionReminders   SubscriptionReminder[]
  referralsGiven          Referral[]               @relation("ReferrerClinic")
  referralsReceived       Referral[]               @relation("ReferredClinic")
  referralCredits         ReferralCredit[]
  mrnSequence             MrnSequence?
}

model DoctorClinic {
  id        String   @id @default(cuid())
  doctorId  String
  clinicId  String
  role      String   @default("doctor")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  clinic    Clinic   @relation(fields: [clinicId], references: [id])
  doctor    User     @relation(fields: [doctorId], references: [id])

  @@unique([doctorId, clinicId])
  @@index([clinicId])
  @@index([doctorId])
}

model PaymentSession {
  id                String    @id @default(cuid())
  clinicId          String
  invoiceId         String?
  patientId         String?
  provider          String    @default("razorpay")
  providerSessionId String?
  paymentLink       String?
  shortUrl          String?
  amount            Int
  currency          String    @default("INR")
  status            String    @default("created")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  paidAt            DateTime?
  failedAt          DateTime?
  expiresAt         DateTime?
  webhookPayload    Json?
  meta              Json?
  whatsappSentAt    DateTime?
  whatsappMessageId String?
  whatsappStatus    String?
  clinic            Clinic    @relation(fields: [clinicId], references: [id])
  invoice           Invoice?  @relation(fields: [invoiceId], references: [id])
  patient           Patient?  @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([invoiceId])
  @@index([providerSessionId])
  @@index([status])
}

model WhatsappLog {
  id                String    @id @default(cuid())
  clinicId          String
  patientId         String?
  paymentSessionId  String?
  type              String
  provider          String    @default("twilio")
  providerMessageId String?
  phoneNumber       String
  message           String
  status            String    @default("queued")
  requestBody       Json?
  responseBody      Json?
  errorMessage      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deliveredAt       DateTime?
  clinic            Clinic    @relation(fields: [clinicId], references: [id])
  patient           Patient?  @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([paymentSessionId])
  @@index([status])
}

model IcdCode {
  id          String               @id @default(cuid())
  code        String               @unique
  description String
  category    String
  version     String               @default("ICD-10")
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  diagnoses   Diagnosis[]
  favorites   DoctorFavoriteCode[]

  @@index([code])
  @@index([description])
  @@index([category])
}

model CptCode {
  id          String               @id @default(cuid())
  code        String               @unique
  description String
  category    String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  price       Float                @default(0)
  favorites   DoctorFavoriteCode[]
  procedures  Procedure[]

  @@index([code])
  @@index([description])
  @@index([category])
}

model Diagnosis {
  id            String      @id @default(cuid())
  appointmentId String
  icdCodeId     String?
  notes         String?
  isPrimary     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  icdCode       IcdCode?    @relation(fields: [icdCodeId], references: [id])

  @@index([appointmentId])
  @@index([icdCodeId])
}

model Procedure {
  id            String      @id @default(cuid())
  appointmentId String
  cptCodeId     String?
  description   String
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  cptCode       CptCode?    @relation(fields: [cptCodeId], references: [id])

  @@index([appointmentId])
  @@index([cptCodeId])
}

model DoctorFavoriteCode {
  id        String   @id @default(cuid())
  userId    String
  icdCodeId String?
  cptCodeId String?
  createdAt DateTime @default(now())
  cptCode   CptCode? @relation(fields: [cptCodeId], references: [id], onDelete: Cascade)
  icdCode   IcdCode? @relation(fields: [icdCodeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, icdCodeId])
  @@unique([userId, cptCodeId])
  @@index([userId])
}

model ImportJob {
  id            String          @id @default(cuid())
  clinicId      String
  type          ImportJobType
  status        ImportJobStatus @default(PENDING)
  fileName      String?
  fileUrl       String?
  columnMapping Json?
  totalRecords  Int             @default(0)
  processed     Int             @default(0)
  successful    Int             @default(0)
  failed        Int             @default(0)
  errors        Json?
  results       Json?
  createdBy     String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  completedAt   DateTime?
  clinic        Clinic          @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
  @@index([status])
}

model OcrDocument {
  id            String    @id @default(cuid())
  clinicId      String
  patientId     String?
  sourceUrl     String
  processedUrl  String?
  documentType  String    @default("UNKNOWN")
  ocrText       String?
  extractedData Json?
  confidence    Float?
  status        String    @default("pending")
  reviewedBy    String?
  reviewedAt    DateTime?
  corrections   Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
}

model PatientMergeSuggestion {
  id              String    @id @default(cuid())
  clinicId        String
  patient1Id      String
  patient2Id      String
  similarityScore Float
  matchReasons    Json
  status          String    @default("pending")
  mergedBy        String?
  mergedAt        DateTime?
  createdAt       DateTime  @default(now())

  @@unique([patient1Id, patient2Id])
  @@index([clinicId])
  @@index([status])
}

model AuditLog {
  id         String   @id @default(cuid())
  clinicId   String
  userId     String
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  clinic     Clinic   @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model QueueToken {
  id                String       @id @default(cuid())
  clinicId          String
  appointmentId     String?      @unique
  patientId         String
  tokenNumber       Int
  status            String       @default("waiting")
  priority          Int          @default(0)
  notes             String?
  calledAt          DateTime?
  completedAt       DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  consultationEnd   DateTime?
  consultationStart DateTime?
  doctorId          String?
  estimatedDuration Int          @default(15)
  estimatedWaitTime Int?
  scheduledTime     DateTime?
  tokenType         String       @default("walk-in")
  appointment       Appointment? @relation(fields: [appointmentId], references: [id])
  clinic            Clinic       @relation(fields: [clinicId], references: [id])
  doctor            User?        @relation(fields: [doctorId], references: [id])
  patient           Patient      @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([doctorId])
  @@index([status])
  @@index([createdAt])
  @@index([scheduledTime])
  @@index([clinicId, status, createdAt])
  @@index([doctorId, status])
  @@index([patientId])
}

model InventoryItem {
  id            String              @id @default(cuid())
  clinicId      String
  name          String
  category      String
  sku           String?
  quantity      Int                 @default(0)
  minQuantity   Int                 @default(10)
  unit          String              @default("units")
  purchasePrice Float?
  sellingPrice  Float?
  expiryDate    DateTime?
  batchNumber   String?
  supplier      String?
  active        Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  movements     InventoryMovement[]

  @@index([clinicId])
  @@index([category])
  @@index([expiryDate])
}

model InventoryMovement {
  id              String        @id @default(cuid())
  inventoryItemId String
  type            String
  quantity        Int
  referenceType   String?
  referenceId     String?
  notes           String?
  createdBy       String
  createdAt       DateTime      @default(now())
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@index([inventoryItemId])
  @@index([type])
  @@index([createdAt])
}

model LabTest {
  id          String         @id @default(cuid())
  clinicId    String
  name        String
  code        String?        // Internal lab code
  loincCode   String?        // LOINC code for interoperability
  category    String
  price       Float?
  description String?
  
  // Reference ranges for result interpretation
  referenceRangeLow   Float?
  referenceRangeHigh  Float?
  referenceRangeUnit  String?
  referenceRangeText  String? // For non-numeric ranges like "Negative"
  
  // Specimen and collection requirements
  specimenType        String? // Blood, Urine, Tissue, etc.
  collectionRequirements String? // Fasting, timing, etc.
  
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  orders      LabTestOrder[]
  loincRef    LoincCode?     @relation(fields: [loincCode], references: [code])

  @@index([clinicId])
  @@index([category])
  @@index([loincCode])
}

model LabTestOrder {
  id            String    @id @default(cuid())
  clinicId      String
  patientId     String
  appointmentId String?
  labTestId     String
  status        String    @default("ordered")
  result        Json?
  resultUrl     String?
  notes         String?
  orderedBy     String
  collectedAt   DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  labTest       LabTest   @relation(fields: [labTestId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
}

model WhatsappFlow {
  id        String   @id @default(cuid())
  clinicId  String
  name      String
  trigger   String
  template  String
  timing    Json?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([trigger])
}

model WhatsappConversation {
  id            String            @id @default(cuid())
  clinicId      String
  patientId     String
  status        String            @default("open")
  lastMessageAt DateTime?
  context       Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  messages      WhatsappMessage[]

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
}

model WhatsappMessage {
  id             String               @id @default(cuid())
  conversationId String
  direction      String
  messageType    String
  content        String
  mediaUrl       String?
  status         String               @default("sent")
  providerMsgId  String?
  createdAt      DateTime             @default(now())
  conversation   WhatsappConversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId])
  @@index([createdAt])
}

enum Role {
  DOCTOR
  RECEPTIONIST
  ADMIN
  SUPER_ADMIN
  ADMIN_DOCTOR
}

enum Gender {
  MALE
  FEMALE
  OTHER
  INTERSEX
  NON_BINARY
  PREFER_NOT_TO_SAY
}

// ============================================================================
// Hospital-Grade Medical Enums
// ============================================================================

// Code Status - Critical patient safety information (DNR/Full Code)
enum CodeStatus {
  FULL_CODE           // Full resuscitation efforts
  DNR                 // Do Not Resuscitate
  DNI                 // Do Not Intubate
  DNR_DNI             // Do Not Resuscitate or Intubate
  COMFORT_CARE        // Comfort measures only
}

// Blood Pressure Position - Clinical context for BP readings
enum BpPosition {
  SITTING
  STANDING
  LYING
  UNKNOWN
}

// Oxygen Delivery Method - Required when recording SpO2
enum OxygenDelivery {
  ROOM_AIR            // No supplemental oxygen
  NASAL_CANNULA       // Low-flow nasal oxygen
  SIMPLE_MASK         // Simple face mask
  NON_REBREATHER      // Non-rebreather mask
  VENTURI_MASK        // Venturi mask for precise FiO2
  HIGH_FLOW           // High-flow nasal cannula
  CPAP                // Continuous positive airway pressure
  BIPAP               // Bilevel positive airway pressure
  VENTILATOR          // Mechanical ventilation
  OTHER
}

// Blood Pressure Migration Status - For legacy data migration
enum BpMigrationStatus {
  PENDING             // Not yet migrated
  MIGRATED            // Successfully parsed and migrated
  FLAGGED             // Non-standard format, needs manual review
  MANUAL              // Manually corrected
}

// Dosage Form - Pharmaceutical dosage forms
enum DosageForm {
  TABLET
  CAPSULE
  SOLUTION
  SUSPENSION
  INJECTION
  CREAM
  OINTMENT
  GEL
  PATCH
  INHALER
  NEBULIZER
  SUPPOSITORY
  DROPS
  SPRAY
  POWDER
  LOZENGE
  FILM
  OTHER
}

// Standardized Frequency Codes (SIG codes)
enum SigCode {
  QD                  // Once daily
  BID                 // Twice daily
  TID                 // Three times daily
  QID                 // Four times daily
  Q4H                 // Every 4 hours
  Q6H                 // Every 6 hours
  Q8H                 // Every 8 hours
  Q12H                // Every 12 hours
  QHS                 // At bedtime
  QAM                 // Every morning
  QPM                 // Every evening
  QOD                 // Every other day
  QWK                 // Once weekly
  PRN                 // As needed
  STAT                // Immediately
  AC                  // Before meals
  PC                  // After meals
  OTHER
}

// Consent Types - For legal and compliance tracking
enum ConsentType {
  TREATMENT           // General treatment consent
  PROCEDURE           // Procedure-specific consent
  SURGERY             // Surgical consent
  ANESTHESIA          // Anesthesia consent
  HIPAA_RELEASE       // HIPAA information release
  RESEARCH            // Research participation
  PHOTO_VIDEO         // Photo/video consent
  TELEHEALTH          // Telemedicine consent
  MINOR_GUARDIAN      // Guardian consent for minor
  BLOOD_TRANSFUSION   // Blood transfusion consent
  VACCINATION         // Vaccination consent
}

// Consent Status
enum ConsentStatus {
  ACTIVE              // Currently valid
  REVOKED             // Patient revoked consent
  EXPIRED             // Consent period ended
  PENDING             // Awaiting signature
}

// Immunization Route
enum ImmunizationRoute {
  IM                  // Intramuscular
  SC                  // Subcutaneous
  ID                  // Intradermal
  PO                  // Oral
  IN                  // Intranasal
  OTHER
}

// Immunization Site
enum ImmunizationSite {
  LEFT_ARM
  RIGHT_ARM
  LEFT_THIGH
  RIGHT_THIGH
  LEFT_DELTOID
  RIGHT_DELTOID
  OTHER
}

enum Specialization {
  GENERAL_PRACTICE
  DENTAL
  CARDIOLOGY
  PEDIATRICS
  OPHTHALMOLOGY
  DERMATOLOGY
  ORTHOPEDICS
  NEUROLOGY
  GYNECOLOGY
  ENT
  PSYCHIATRY
  UROLOGY
  PULMONOLOGY
  GASTROENTEROLOGY
  ONCOLOGY
  NEPHROLOGY
  ENDOCRINOLOGY
  RHEUMATOLOGY
  RADIOLOGY
  PATHOLOGY
  ANESTHESIOLOGY
  EMERGENCY_MEDICINE
  FAMILY_MEDICINE
  INTERNAL_MEDICINE
  PLASTIC_SURGERY
  GENERAL_SURGERY
  OTHER
}

enum HospitalRole {
  CONSULTANT
  SENIOR_CONSULTANT
  JUNIOR_DOCTOR
  RESIDENT
  INTERN
  VISITING_DOCTOR
  HEAD_OF_DEPARTMENT
  MEDICAL_DIRECTOR
  SURGEON
  CHIEF_SURGEON
  ATTENDING_PHYSICIAN
  FELLOW
}

enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

enum ClinicTier {
  CAPTURE
  CORE
  PLUS
  PRO
  ENTERPRISE
}

enum IntelligenceAddon {
  NONE
  ACTIVE
}

enum ImportJobType {
  EXCEL_PATIENTS
  EXCEL_APPOINTMENTS
  OCR_DOCUMENT
  BULK_SCAN
}

enum ImportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

// ============================================================================
// LOINC Codes - Laboratory & Clinical Observation Standards
// ============================================================================

model LoincCode {
  id          String    @id @default(cuid())
  code        String    @unique  // LOINC code (e.g., "2345-7")
  longName    String              // Full descriptive name
  shortName   String?             // Abbreviated name
  component   String?             // What is being measured
  property    String?             // Type of property (e.g., "Mass concentration")
  timeAspect  String?             // Point in time vs. over time
  system      String?             // System/specimen type
  scale       String?             // Quantitative, Ordinal, Nominal
  method      String?             // Method of measurement
  classType   String?             // Class/category
  status      String?             @default("ACTIVE") // Active, Deprecated, etc.
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  labTests    LabTest[]

  @@index([code])
  @@index([component])
  @@index([classType])
}

// ============================================================================
// Immunization/Vaccination Records
// ============================================================================

model Immunization {
  id                String            @id @default(cuid())
  patientId         String
  
  // Vaccine identification
  vaccineName       String            // Common name (e.g., "COVID-19 Vaccine")
  cvxCode           String?           // CDC CVX code
  mvxCode           String?           // Manufacturer MVX code
  ndcCode           String?           // National Drug Code
  
  // Vaccine details
  manufacturer      String?
  lotNumber         String?
  expirationDate    DateTime?
  
  // Administration details
  administeredDate  DateTime
  administeredBy    String?           // Provider who administered
  administeredAt    String?           // Location/facility
  site              ImmunizationSite?
  route             ImmunizationRoute?
  doseNumber        Int?              // e.g., 1st dose, 2nd dose
  seriesComplete    Boolean?          // Is series complete?
  
  // Documentation
  informationSource String?           // e.g., "Historical", "Administered"
  notes             String?
  documentUrl       String?           // Link to immunization record
  
  // Reactions (if any)
  hadReaction       Boolean           @default(false)
  reactionDetails   String?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  patient           Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@index([cvxCode])
  @@index([administeredDate])
}

// ============================================================================
// Consent Management - Legal & Compliance Tracking
// ============================================================================

model Consent {
  id                String        @id @default(cuid())
  patientId         String
  clinicId          String
  
  // Consent details
  consentType       ConsentType
  status            ConsentStatus @default(PENDING)
  
  // Who gave consent
  givenBy           String?       // Name of person giving consent
  givenByRelation   String?       // If not patient (e.g., "Parent", "Guardian")
  givenAt           DateTime?
  
  // Witness information
  witnessedBy       String?       // Name of witness
  witnessedAt       DateTime?
  
  // Validity period
  validFrom         DateTime?
  validUntil        DateTime?
  
  // Revocation tracking
  revokedAt         DateTime?
  revokedBy         String?
  revokedReason     String?
  
  // Associated procedure (for procedure-specific consent)
  procedureId       String?       // Link to Procedure if applicable
  procedureName     String?       // Description of procedure
  
  // Documentation
  documentUrl       String?       // Signed consent form
  templateVersion   String?       // Version of consent template used
  notes             String?
  
  // Audit trail
  createdBy         String?       // Staff who created record
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  patient           Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@index([clinicId])
  @@index([consentType])
  @@index([status])
  @@index([validUntil])
}

// ============================================================================
// MRN Sequence Tracking (for clinic-prefixed sequential MRN generation)
// ============================================================================

model MrnSequence {
  id          String   @id @default(cuid())
  clinicId    String   @unique
  prefix      String   // e.g., "DOC", "CLI"
  lastNumber  Int      @default(0) // Last used sequence number
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  clinic      Clinic   @relation(fields: [clinicId], references: [id])
  
  @@index([clinicId])
}

// ============================================================================
// Feedback System
// ============================================================================

model Feedback {
  id                 String           @id @default(cuid())
  clinicId           String
  userId             String
  
  // Rating (1-5 stars)
  overallRating      Int              @default(3)
  
  // Feature feedback
  goodFeatures       String[]         // List of features user likes
  goodFeaturesReason String?          // Why they like these features
  
  badFeatures        String[]         // List of features user dislikes
  badFeaturesReason  String?          // Why they dislike these features
  
  improvementAreas   String[]         // Features that need improvement
  improvementReason  String?          // How to improve them
  
  featureRequests    String?          // New feature requests
  
  // Additional feedback
  generalComments    String?          // Any other comments
  
  // Metadata
  category           FeedbackCategory @default(GENERAL)
  status             FeedbackStatus   @default(NEW)
  adminNotes         String?          // Notes from admin reviewing feedback
  
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  
  // Relations
  clinic             Clinic           @relation(fields: [clinicId], references: [id])
  user               User             @relation(fields: [userId], references: [id])
  
  @@index([clinicId])
  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
}

enum FeedbackCategory {
  GENERAL
  UI_UX
  PERFORMANCE
  FEATURES
  BILLING
  SUPPORT
  OTHER
}

enum FeedbackStatus {
  NEW
  REVIEWED
  IN_PROGRESS
  RESOLVED
  ARCHIVED
}

// ============================================================================
// Production Analytics & Monitoring
// ============================================================================

model ApiRequest {
  id           String   @id @default(cuid())
  clinicId     String?
  userId       String?
  method       String
  path         String
  statusCode   Int
  duration     Int      // in milliseconds
  requestSize  Int?     // in bytes
  responseSize Int?     // in bytes
  userAgent    String?
  ip           String?
  error        String?
  errorStack   String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([clinicId])
  @@index([userId])
  @@index([path])
  @@index([statusCode])
  @@index([createdAt])
  @@index([duration])
}

model ErrorLog {
  id           String          @id @default(cuid())
  clinicId     String?
  userId       String?
  type         String          // HttpException, PrismaError, UnhandledError, etc.
  message      String
  stack        String?
  path         String?
  method       String?
  statusCode   Int?
  userAgent    String?
  ip           String?
  requestBody  Json?
  metadata     Json?
  severity     ErrorSeverity   @default(ERROR)
  resolved     Boolean         @default(false)
  resolvedBy   String?
  resolvedAt   DateTime?
  createdAt    DateTime        @default(now())

  @@index([clinicId])
  @@index([type])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
}

model SystemMetric {
  id             String       @id @default(cuid())
  metricType     MetricType
  value          Float
  unit           String?
  metadata       Json?
  recordedAt     DateTime     @default(now())

  @@index([metricType])
  @@index([recordedAt])
}

model PerformanceAggregate {
  id               String   @id @default(cuid())
  path             String
  method           String
  period           String   // hourly, daily
  periodStart      DateTime
  totalRequests    Int
  successCount     Int
  errorCount       Int
  avgDuration      Float
  minDuration      Int
  maxDuration      Int
  p50Duration      Int?
  p95Duration      Int?
  p99Duration      Int?
  createdAt        DateTime @default(now())

  @@unique([path, method, period, periodStart])
  @@index([period])
  @@index([periodStart])
  @@index([path])
}

enum ErrorSeverity {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum MetricType {
  CPU_USAGE
  MEMORY_USAGE
  HEAP_USED
  HEAP_TOTAL
  ACTIVE_CONNECTIONS
  DB_QUERY_TIME
  UPTIME
  REQUEST_COUNT
  ERROR_RATE
  AVG_RESPONSE_TIME
}

// ============================================================================
// Subscription & Billing System
// ============================================================================

model Subscription {
  id                     String             @id @default(cuid())
  clinicId               String             @unique
  plan                   ClinicTier         @default(CORE)
  billingCycle           BillingCycle       @default(MONTHLY)
  priceCents             Int                // Price in paise (INR cents)
  currency               String             @default("INR")
  status                 SubscriptionStatus @default(ACTIVE)

  // Razorpay integration
  razorpaySubscriptionId String?            // Razorpay subscription ID
  razorpayPlanId         String?            // Razorpay plan ID

  // Period tracking
  currentPeriodStart     DateTime
  currentPeriodEnd       DateTime
  trialEnd               DateTime?
  cancelledAt            DateTime?
  cancelAtPeriodEnd      Boolean            @default(false)

  // Credits & proration
  creditsCents           Int                @default(0) // Monetary credits from proration/referrals

  // Scheduled changes (for downgrades or cycle switches)
  scheduledChange        Json?              // {plan, billingCycle, effectiveAt}

  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  clinic                 Clinic             @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  payments               SubscriptionPayment[]
  reminders              SubscriptionReminder[]

  @@index([status])
  @@index([currentPeriodEnd])
  @@index([razorpaySubscriptionId])
}

model SubscriptionPayment {
  id                  String        @id @default(cuid())
  clinicId            String
  subscriptionId      String?

  amountCents         Int           // Amount in paise
  currency            String        @default("INR")
  status              String        // pending, paid, failed, refunded

  // Razorpay details
  razorpayPaymentId   String?
  razorpayOrderId     String?
  razorpaySignature   String?

  // Invoice details
  invoiceUrl          String?
  invoiceNumber       String?

  // Proration info
  isProrated          Boolean       @default(false)
  proratedDays        Int?
  originalAmountCents Int?

  // Credits applied
  creditsApplied      Int           @default(0)

  description         String?
  failureReason       String?

  paidAt              DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  clinic              Clinic        @relation(fields: [clinicId], references: [id])
  subscription        Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([clinicId])
  @@index([subscriptionId])
  @@index([status])
  @@index([razorpayPaymentId])
}

model SubscriptionReminder {
  id             String        @id @default(cuid())
  clinicId       String
  subscriptionId String?

  type           String        // expiry_7d, expiry_3d, expiry_1d, expired, grace_1d, grace_2d, grace_3d
  channel        String        // email, whatsapp, in_app
  status         String        @default("pending") // pending, sent, failed

  sentAt         DateTime?
  errorMessage   String?

  createdAt      DateTime      @default(now())

  clinic         Clinic        @relation(fields: [clinicId], references: [id])
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  @@unique([clinicId, type, createdAt])
  @@index([clinicId])
  @@index([type])
  @@index([status])
}

// ============================================================================
// Referral System
// ============================================================================

model Referral {
  id               String         @id @default(cuid())
  referrerClinicId String
  referredClinicId String?        // null until referred clinic signs up

  referredEmail    String         // Email used for invitation
  referredDomain   String?        // Domain extracted from email for anti-abuse
  referralCode     String         // The referral code used

  status           ReferralStatus @default(PENDING)

  // Discount for referred clinic
  discountPercent  Int            @default(25) // 25% off first month
  discountApplied  Boolean        @default(false)

  // Credit for referrer
  creditMonths     Int            @default(1) // 1 free month per successful referral
  creditApplied    Boolean        @default(false)

  inviteSentAt     DateTime?
  signedUpAt       DateTime?
  convertedAt      DateTime?      // When first payment completed
  rejectedAt       DateTime?
  rejectionReason  String?

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  referrerClinic   Clinic         @relation("ReferrerClinic", fields: [referrerClinicId], references: [id])
  referredClinic   Clinic?        @relation("ReferredClinic", fields: [referredClinicId], references: [id])

  @@index([referrerClinicId])
  @@index([referredClinicId])
  @@index([referredEmail])
  @@index([referralCode])
  @@index([status])
}

model ReferralCredit {
  id           String    @id @default(cuid())
  clinicId     String
  referralId   String

  creditMonths Int       // Months credited
  appliedAt    DateTime  @default(now())
  expiresAt    DateTime? // Credits may expire
  usedAt       DateTime? // When credit was consumed

  createdAt    DateTime  @default(now())

  clinic       Clinic    @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
  @@index([referralId])
}

// ============================================================================
// Billing Enums
// ============================================================================

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  GRACE
  CANCELLED
  EXPIRED
  PAUSED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum ReferralStatus {
  PENDING      // Invite sent, waiting for signup
  SIGNED_UP    // Referred clinic created account
  CONVERTED    // First payment completed - credits applied
  REJECTED     // Failed validation (same domain, abuse, etc.)
  EXPIRED      // Invite expired without signup
}
